<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC AI Predictor - 4小时K线预测</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #58a6ff; margin-bottom: 20px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: #161b22; padding: 20px; border-radius: 8px; border: 1px solid #30363d; }
    .stat-value { font-size: 28px; font-weight: bold; color: #58a6ff; }
    .stat-label { font-size: 12px; color: #8b949e; margin-top: 5px; }
    .chart-container { background: #161b22; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #30363d; }
    th { background: #21262d; }
    .buy { color: #3fb950; } .sell { color: #f85149; } .hold { color: #d29922; }
    .correct { color: #3fb950; } .wrong { color: #f85149; }
  </style>
</head>
<body>
  <div class="container">
    <h1>BTC AI Predictor - 4小时K线预测</h1>
    <div class="stats" id="stats"></div>
    <div class="chart-container">
      <canvas id="chart" height="300"></canvas>
    </div>
    <div class="chart-container">
      <table>
        <thead>
          <tr>
            <th>时间</th>
            <th>信号</th>
            <th>置信</th>
            <th>预测收盘</th>
            <th>实际收盘</th>
            <th>结果</th>
            <th>误差</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
  <script>
    let chart;
    
    async function load() {
      try {
        const [statsRes, compsRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/comparison')
        ]);
        
        const stats = await statsRes.json();
        const comps = await compsRes.json();
        
        document.getElementById('stats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${stats.totalPredictions || 0}</div>
            <div class="stat-label">总预测</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.completedPredictions || 0}</div>
            <div class="stat-label">已完成</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.accuracy || 'N/A'}</div>
            <div class="stat-label">准确率</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.avgError || 'N/A'}</div>
            <div class="stat-label">平均误差</div>
          </div>
        `;
        
        const data = comps.slice(-20);
        
        if (chart) chart.destroy();
        
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map((_, i) => '预测' + (i + 1)),
            datasets: [
              { label: 'AI预测', data: data.map(c => c.prediction?.close), borderColor: '#58a6ff', tension: 0.1 },
              { label: '实际价格', data: data.map(c => c.real?.close), borderColor: '#3fb950', tension: 0.1 }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: '预测 vs 实际价格' }
            }
          }
        });
        
        let html = '';
        data.slice().reverse().forEach(c => {
          if (!c.prediction) return;
          const p = c.prediction;
          const signalClass = p.signal?.includes('买入') ? 'buy' : p.signal?.includes('卖出') ? 'sell' : 'hold';
          const resultClass = c.accuracy?.directionCorrect ? 'correct' : 'wrong';
          
          html += '<tr>';
          html += '<td>' + new Date(p.time).toLocaleString('zh-CN') + '</td>';
          html += '<td class="' + signalClass + '">' + (p.signal || '-') + '</td>';
          html += '<td>' + ((p.confidence || 0) * 100).toFixed(0) + '%</td>';
          html += '<td>$' + (p.close?.toLocaleString() || '-') + '</td>';
          html += '<td>$' + (c.real?.close?.toLocaleString() || '-') + '</td>';
          html += '<td class="' + resultClass + '">' + (c.accuracy ? (c.accuracy.directionCorrect ? '正确' : '错误') : '-') + '</td>';
          html += '<td>' + (c.accuracy ? c.accuracy.error.toFixed(2) + '%' : '-') + '</td>';
          html += '</tr>';
        });
        
        document.getElementById('tbody').innerHTML = html;
        
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }
    
    load();
    setInterval(load, 10000);
  </script>
</body>
</html>
